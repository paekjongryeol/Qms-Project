<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qms.order.dao.OrderDao">
					 
	<resultMap type="com.qms.order.vo.OrderVO" id="orderMap">
		<result property="orderNo" 		    	column="ORDER_NO"/>
		<result property="compCd" 	        	column="COMP_CD"/>
		<result property="orderStatus" 			column="ORDER_STATUS"/>
		<result property="orderStatusNm" 		column="ORDER_STATUS_NM"/>
		<result property="regDt" 		    	column="REG_DT"/>
		<result property="regUserId" 	    	column="REG_USER_ID"/>
		<result property="updDt" 		    	column="UPD_DT"/>
		<result property="updUserId"	    	column="UPD_USER_ID"/>
		<result property="deliveryDt" 	    	column="DELIVERY_DT"/>
		<result property="itemCd" 	        	column="ITEM_CD"/>
		<result property="orderQty" 	    	column="ORDER_QTY"/>
		<result property="orderPrice" 			column="ORDER_PRICE"/>
		<result property="compName"	 			column="COMP_NAME"/>
		<result property="unitPrice" 			column="UNIT_PRICE"/>
		<result property="itemName" 			column="ITEM_NAME"/>
		<result property="deliveryDtFrom" 		column="DELIVERY_DT_FROM" />
        <result property="deliveryDtTo" 		column="DELIVERY_DT_TO" />
        <result property="boxQty"       		column="BOX_QTY" />
        <result property="boxType" 		        column="BOX_TYPE" />
        
		
	  </resultMap>
	  
	<select id="selectTotalOrderCount" resultType="integer">
	 SELECT 
	        COUNT(*)
	    FROM
	        TB_ORDER_INFO A,
	        (
	            SELECT  
	                C.ORDER_NO,
	                D.ITEM_NAME,
	                D.UNIT_PRICE,
	                C.ORDER_QTY,
	                C.ORDER_PRICE,
	                C.ITEM_CD 
	            FROM 
	                TB_ITEM_INFO D, 
	                TB_ORDER_ITEM C 
	            WHERE 
	                D.ITEM_CD = C.ITEM_CD
	        ) B
	       WHERE  A.ORDER_NO = B.ORDER_NO
		
	
	</select>
	
	<select id="selectOrderlist" resultMap="orderMap">
	SELECT 
			    	RN,
					ORDER_NO,
					COMP_CD,
					COMP_NAME,
					ITEM_CD,
					ITEM_NAME,
					UNIT_PRICE,
					BOX_TYPE,
					ORDER_QTY,
					ORDER_PRICE,
					ORDER_STATUS,
					ORDER_STATUS_NM,
					DELIVERY_DT,
					REG_DT
    	FROM
    		(SELECT 
			    	ROW_NUMBER() OVER(ORDER BY A.ORDER_NO DESC) RN,
				    A.ORDER_NO,
				    A.COMP_CD,
				    C.COMP_NAME,
				    B.ITEM_CD,
				    B.ITEM_NAME,
				    B.UNIT_PRICE,
				    B.BOX_TYPE,
				    B.ORDER_QTY,
				    B.ORDER_PRICE,
				    A.ORDER_STATUS,
				    E.COM_NAME ORDER_STATUS_NM,
				    TO_CHAR(A.DELIVERY_DT, 'YYYY-MM-DD')  DELIVERY_DT,
            		TO_CHAR(A.REG_DT, 'YYYY-MM-DD')  REG_DT
				FROM
				    TB_ORDER_INFO A, 
				    TB_PARTNER_INFO C,
				    TB_COM_CODE E,
				    (
				    SELECT  C.ORDER_NO, D.ITEM_NAME ,D.UNIT_PRICE, C.ORDER_QTY, C.ORDER_PRICE, C.ITEM_CD, D.BOX_TYPE  
				        FROM TB_ITEM_INFO D, TB_ORDER_ITEM C 
				        WHERE D.ITEM_CD = C.ITEM_CD) B
				WHERE
				    A.ORDER_NO = B.ORDER_NO
				    AND A.COMP_CD = C.COMP_CD
				    AND A.ORDER_STATUS = E.COM_CD
				    AND E.COM_GRP_CD = 'OR01'
				     <if test="compName!=null and compName!=''">
		             and C.COMP_NAME like '%'||#{compName}||'%'
		             </if>
					 <if test="compCd != null and compCd != ''">
	           		 AND COMP_CD LIKE '%' || #{compCd} || '%'
	        		 </if>
					 <if test="itemCd!=null and itemCd!=''">
					 AND ITEM_CD LIKE '%'||#{itemCd}||'%'
					 </if>
					 <if test="deliveryDtFrom != null and deliveryDtFrom != ''">
			         AND TO_CHAR(A.DELIVERY_DT, 'yyyy-mm-dd') <![CDATA[>=]]> #{deliveryDtFrom}
		      	     </if>
		      	     <if test="deliveryDtTo != null and deliveryDtTo != ''">
		       	     AND TO_CHAR(A.DELIVERY_DT, 'yyyy-mm-dd') <![CDATA[<=]]> #{deliveryDtTo}
		      	     </if>
					)
					WHERE RN<![CDATA[ > ]]>(#{currentPage}-1)*#{countPerPage} 
					AND RN<![CDATA[ <= ]]>#{currentPage}*#{countPerPage} 
	</select>
	
	<select id="selectOrderDtlList" resultMap="orderMap">
		SELECT
    	    RN,
 		    ITEM_CD,
 		    ITEM_NAME,
  		    BOX_QTY,
    		BOX_TYPE,
   		    UNIT_PRICE,
    		ORDER_QTY,
    		ORDER_PRICE,
    		ORDER_NO,
    		COMP_CD,
    		DELIVERY_DT,
    		ORDER_STATUS,
    		ORDER_STATUS_NM
		FROM (
   		  SELECT
        	ROWNUM AS RN,
        	A.ITEM_CD,
        	B.ITEM_NAME,
        	B.BOX_QTY,
        	B.BOX_TYPE,
       		B.UNIT_PRICE,
        	A.ORDER_QTY,
        	A.ORDER_PRICE,
        	C.ORDER_NO,
        	C.ORDER_STATUS,
        	E.COM_NAME ORDER_STATUS_NM,
        	C.COMP_CD,
        	TO_CHAR(C.DELIVERY_DT,'YYYY-MM-DD') DELIVERY_DT
    	FROM TB_ORDER_ITEM A,
    	     TB_ITEM_INFO B,
    	     TB_ORDER_INFO C, 
    	     TB_COM_CODE E
    	    	
    	WHERE A.ORDER_NO = #{orderNo}
    	AND A.ITEM_CD = B.ITEM_CD
    	AND A.ORDER_NO = C.ORDER_NO
    	AND C.ORDER_STATUS = E.COM_CD
        AND E.COM_GRP_CD = 'OR01'
			)
		
	    WHERE RN<![CDATA[ > ]]>(#{currentPage}-1)*#{countPerPage} 
		AND RN<![CDATA[ <= ]]>#{currentPage}*#{countPerPage}	

	   
	</select>
	
	<delete id="deleteOrder">
		DELETE FROM TB_ORDER_ITEM	
		WHERE ORDER_NO = #{orderNo}
	</delete>
	
	<insert id="updateOrderList" >
	
	  INSERT INTO TB_ORDER_ITEM (ORDER_NO, COMP_CD, ITEM_CD, ORDER_QTY, ORDER_PRICE, REG_DT ,REG_USER_ID )
	  VALUES( #{orderNo}, #{compCd}, #{itemCd}, #{orderQty}, #{orderPrice}, SYSDATE, #{userId})
	   
	
	</insert>
	
	<insert id="insertOrderInfo">
	
    INSERT INTO TB_ORDER_INFO (ORDER_NO, COMP_CD, ORDER_STATUS, REG_DT, DELIVERY_DT, REG_USER_ID)
    VALUES ( #{orderNo}, #{compCd}, '01', SYSDATE, #{deliveryDt}, #{userId})
    
	</insert>
	
	<update id="insertOrderDt">
	    UPDATE TB_ORDER_INFO
		SET DELIVERY_DT = #{deliveryDt}
	    WHERE ORDER_NO = #{orderNo}
	
	</update>
	
	<update id = "upOrderStatus">
		UPDATE TB_ORDER_INFO
		SET ORDER_STATUS = '02'
		WHERE ORDER_NO = #{orderNo}
	</update>
	
	<select id ="selectMaxOrderNo" resultType="String">
	        SELECT
				CASE
				WHEN
		            TO_CHAR(SYSDATE, 'YYYYMM') = MAX(SUBSTR(ORDER_NO, 1,6))
				THEN
		            REPLACE((TO_CHAR(SYSDATE, 'YYYYMM')||
		                                    TO_CHAR((SUBSTR(MAX(ORDER_NO),7,2)+1),'00')),' ','')
				ELSE
		            REPLACE((TO_CHAR(SYSDATE, 'YYYYMM')|| '01'),' ','')
				END  ORDER_NO
				FROM
					TB_ORDER_INFO     
	    </select>
	
</mapper>